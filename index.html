<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Animal Jam Classic</title>
  </head>

  <body>
    <style>
      body {
        background-color: #F5C86D;
        opacity: 0;
        margin: 0;
        overflow: hidden;
        user-select: none;
        cursor: default;
        background-image: url(images/electron_login/log_bg_swirl_pattern.svg);
      }

      body.show {
        transition: opacity 0.75s;
        opacity: 1;
      }

      .no-transition-delays {
        transition: transform 0s !important;
      }

      #game-screen {
        transition: transform 1s;
        width: 100%;
        height: 100%;
        /*TODO: find out why absolute appears to be working like relative*/
        position: absolute;
      }

      #game-screen.show {
        transform: translateY(calc(calc(100vh - 2px) * -1));
      }

      #modal-layer {
        display: flex;
        position: absolute;
        z-index: 1;
        background-color: rgba(0, 0, 0, 0.65);
      }

      @font-face {
        font-family: 'Tiki-Island';
        src: url("fonts/tiki-island/Tiki-Island.woff");
        font-weight: normal;
        font-style: normal;
      }

      @font-face {
        font-family: 'CCDigitalDelivery';
        src: url("fonts/digital-delivery/CCDigitalDeliveryRegular.woff");
        font-weight: normal;
        font-style: normal;
      }

      @font-face {
        font-family: 'CCDigitalDelivery-Bold';
        src: url("fonts/digital-delivery/CCDigitalDeliveryBold.woff");
        font-weight: bold;
        font-style: normal;
      }

      @font-face {
        font-family: 'CCDigitalDelivery-BoldItalic';
        src: url("fonts/digital-delivery/CCDigitalDeliveryBoldItalic.woff");
        font-weight: bold;
        font-style: italic;
      }

      @font-face {
        font-family: 'CCDigitalDelivery-Italic';
        src: url("fonts/digital-delivery/CCDigitalDeliveryItalic.woff");
        font-weight: normal;
        font-style: italic;
      }
    </style>
    <script src="translation.js"></script> 
    <script src="config.js"></script> 
    <script>
      let webview = null;
      // Object.defineProperty(navigator, " Agent", {
      //   get: function () {
      //     return "Mozilla/5.0 (Windows NT 10.0; Win64; x64) Electron/9.0.0 AJClassicStage/9.9.6";
      //   },
      //   configurable: true
      // });
      // console.log(window.navigator.userAgent.toString());
      // window.navigator.userAgent = "Mozilla/5.0 (Windows NT 10.0; Win64; x64) Electron/9.0.0 AJClassicStage/9.9.7"
      function uuidv4() {
        return "f6ca05c0-fad5-46fc-a237-a8e930e7cb49";
      }
      const getDf = async () => {
        let df = localStorage.getItem("login.df");
        console.log(df == undefined);
        if (df == undefined) {
          try {
            df = "5eb3c822-74ef-4397-b1d4-d6a8fde512c2";
          }
          catch (err) {
            console.log("debugError", JSON.stringify(err));
            df = uuidv4();
          }
          localStorage.setItem("login.df", df);
        }
        return df;
      };
      document.addEventListener("loginSucceeded", (event) => {
        const message = event.detail;
        //console.log("debug", `Saving login data: ${JSON.stringify(message)}`);

        localStorage.setItem("login.username", message.username);
        localStorage.setItem("login.language", message.language);
        translation.setLanguage(message.language);
        localStorage.setItem("login.rememberMe", message.rememberMe);
        if (message.rememberMe) {
          localStorage.setItem("login.authToken", message.authToken);
          if (message.refreshToken) {
            localStorage.setItem("login.refreshToken", message.refreshToken);
          }
        }
        else {
          localStorage.removeItem("login.authToken");
          localStorage.removeItem("login.refreshToken");
        }

        // if (message.accountType > 2) {
        //   setApplicationMenu();
        // }
      });
      window.addEventListener("loaded", async (event) => {
        webview = event.sender;
        const username = localStorage.getItem("login.username") || "";
        // Default remember me to true
        const rememberMe = localStorage.getItem("login.rememberMe") !== false;
        const authToken = localStorage.getItem("login.authToken") || null;
        const refreshToken = localStorage.getItem("login.refreshToken") || null;
        const df = await getDf();
        console.log("the user is", username);
        document.dispatchEvent(new CustomEvent("loginInfoLoaded", {
          username,
          authToken,
          refreshToken,
          rememberMe,
          df,
          config,
          rcToken,
        }));
        console.log("sending token")
        document.dispatchEvent(new CustomEvent("obtainedToken", {
            token: authToken,
        }));
      });

      "use strict";
      (() => {
        const head = document.querySelector("head");
        window.addEventListener("preloadAssets", event => {
          for (const url of event.detail.urls) {
            head.innerHTML += `<link rel="preload" as="image" type="image/svg+xml" href=${url}>`;
          }
        });
      })();
      translation.setLanguage("en");
      let proxy = "https://simple-request-forwarder.onrender.com";
      let rcToken = "";
      async function sha1(str) {
        const enc = new TextEncoder();
        const hash = await crypto.subtle.digest('SHA-1', enc.encode(str));
        return Array.from(new Uint8Array(hash))
          .map(v => v.toString(16).padStart(2, '0'))
          .join('');
      }

      sha1("--rc-token").then(hash => {
        rcToken = hash;
        console.log("Generated Hash:", rcToken);
      });
      
      const globals = {
        config: window.config,
        systemData: {
          version: "22.12.1",
          platform: "win32",
          platformRelease: "10.0.22631"
        },
        authToken: "",
        currentUser: "",
        flashVarsOverride: null,
        language: "en",  // changed later based on preference
        df: "f6ca05c0-fad5-46fc-a237-a8e930e7cb49",
        rcToken: "",
        userAbortController: null,
        vars : {},
        translate(phrase) {
          // return new Promise(resolve => {
          //   const value = cachedTranslations.get(phrase);
          //   if (value) {
          //     resolve(value);
          //   }
          //   else {
          //     const requestId = nextTranslationRequestId;
          //     nextTranslationRequestId++;
          //     pendingTranslations.set(requestId, resolve);
          //     document.dispatchEvent(new CustomEvent("translate", {requestId, phrase}));
          //   }
          // });
          return translation.translate(phrase).value;
        },

        async setLanguage(language) {
          if (language && language != globals.language) {
            globals.language = language;
            translation.setLanguage(language);
            cachedTranslations.clear();
            await globals.localize();
          }
        },

        fetch(url, options = {}, validCodes = []) {
          return new Promise(async (resolve, reject) => {
            //console.log("FETCH DEBUG - url:", url, "options:", options, "validCodes:", validCodes);
            
            if (!options.error) options.error = new Error(); // âœ… No more crashes!
            if (!options.startTime) options.startTime = new Date().getTime();
            options.attempts = options.attempts ? options.attempts + 1 : 1;
            if (!options.maxAttempts) options.maxAttempts = 5;
            if (!options.timeout) options.timeout = 10000;

            const requestAbortController = new AbortController();
            options.signal = requestAbortController.signal;
            setTimeout(() => requestAbortController.abort(), options.timeout);

            if (options.userAbortController !== false && globals.userAbortController) {
              options.userAbortController = globals.userAbortController;
              options.userAbortController.signal.addEventListener("abort", () => requestAbortController.abort());
            }

            try {
              const response = await window.fetch(
                `${proxy}/proxy?url=${encodeURIComponent(url)}`,
                options
              );

              if ([200].concat(validCodes).includes(response.status)) {
                resolve(response);
              } else {
                options.error.message = `Invalid response code: ${response.status} for URL: ${url}`;
                reject(options.error);
              }
            } catch (err) {
              options.error.name = err.name;
              options.error.message = `${err.message} for URL: ${url}`;
              reject(options.error);
            }
          });
        },

        reportError(section, err) {
          const message = err.stack || err.message || err;
          const body = JSON.stringify({
            username: globals.currentUser,
            version: globals.systemData.version,
            platform: globals.systemData.platform,
            message: message.slice(0, 1000),
            section,
          });
          globals.fetch(`${globals.config.api}/v1/reportError`, {
            method: "POST",
            mode: "cors",
            headers: {
              "Content-Type": "application/json"
            },
            body,
            userAbortController: false,  // prevent user from aborting
          }, [413]).catch(err => {
            console.log(err);
          });
        },

        parseBool(val) {
          return val ? val !== "false" : false;
        },

        genericError(err) {
          globals.reportError("webClient", err);
          window.alert("Something went wrong :( : ", err);
        },

        getClientData() {
          return {
            clientPlatform: "win32",
            clientPlatformVersion: globals.systemData.version,
            clientOS: "win"
          };
        },
        // globals.systemData.platform === "darwin"
        //     ? "mac"
        //     : globals.systemData.platform === "win32"
        //     ? "win"
        //     : "unknown",
        async authenticateWithAuthToken(authToken) {
          return await getGameData({auth_token: authToken}, true);
        },

        async authenticateWithRefreshToken(refreshToken, otp) {
          const request = {refresh_token: refreshToken};
          if (otp) {
            request.otp = otp;
          }
          return await authenticate(request);
        },

        async authenticateWithPassword(username, password, otp) {
          const request = {username, password};
          if (otp) {
            request.otp = otp;
          }
          return await authenticate(request);
        },

        async getFlashVarsFromWeb() {
          const response = await globals.fetch(`${globals.config.web}/flashvars`, {
            method: "GET",
            mode: "cors",
            credentials: "include",
          });
          return JSON.parse(await response.text());
        },

        async localize() {
          await document.getElementById("login-screen").localize();
          await document.getElementById("game-screen").localize();
        },

        reloadGame() {
          document.getElementById("login-screen").logIn();
        },
      };
      window.globals = globals;
      const pendingTranslations = new Map();
      const cachedTranslations = new Map();
      let nextTranslationRequestId = 0;

      document.addEventListener("translate", (event) => {
        cachedTranslations.set(event.phrase, event.value);
        const resolve = pendingTranslations.get(event.requestId);
        if (resolve) {
          pendingTranslations.delete(event.requestId);
          resolve(event.value);
        }
      });

      window.addEventListener("error", err => {
        globals.reportError("webClient", err.stack || err.error.stack);
      });
      window.addEventListener("unhandledrejection", event => {
        globals.reportError("webClient", event.reason.stack || event.reason.error.stack);
      });

      const showOtpModal = () => {
        const modal = document.createElement("otp-modal");
        modal.addEventListener("close", event => {
          document.getElementById("modal-layer").removeChild(modal);
        });
        modal.addEventListener("submit", event => {
          document.getElementById("modal-layer").removeChild(modal);
          const loginScreen = document.getElementById("login-screen");
          loginScreen.otp = event.detail.otp;
          loginScreen.logIn();
        });
        document.getElementById("modal-layer").appendChild(modal);
      };

      const showRenameUserModal = async (username, renameToken) => {
        const modal = document.createElement("ajd-rename-user-modal");
        await modal.setUserData({
          username,
          renameToken,
        });
        modal.addEventListener("accountRenamed", event => {
          document.getElementById("login-screen").username = event.detail.username;
          document.getElementById("modal-layer").removeChild(modal);
        });
        modal.addEventListener("close", event => {
          document.getElementById("modal-layer").removeChild(modal);
        });
        document.getElementById("modal-layer").appendChild(modal);
      };

      const authenticate = async (request) => {
        request.domain = "flash";
        request.df = globals.df;
        const response = await globals.fetch(`${globals.config.authenticator}/authenticate`, {
          method: "POST",
          mode: "cors",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(request),
        }, [401, 422, 500]);
        if (response.status === 200) {
          const authenticateData = JSON.parse(await response.text());
          const authenticatedByToken = (request.refresh_token !== undefined);
          return await getGameData(authenticateData, authenticatedByToken);
        }
        // account suspended/banned
        if (response.status === 401) {
          const authError = JSON.parse(await response.text());
          switch (authError.error_code) {
            case 100: throw new Error("REFRESH_TOKEN_EXPIRED");
            case 101: throw new Error("WRONG_CREDENTIALS");
            case 102: throw new Error("BANNED");
            case 103: throw new Error("SUSPENDED");
            default: throw new Error("LOGIN_ERROR");
          }
        }
        // unprocessable request
        if (response.status === 422) {
          const authError = JSON.parse(await response.text());
          if (authError.error == "invalid_otp" || authError.error == "pending_otp_confirmation") {
            showOtpModal();
            throw new Error("OTP_NEEDED");
          }
          throw new Error("LOGIN_ERROR");
        }
        // unexpected response: log details and show generic login error
        throw new Error("ERROR");
      };

      const getGameData = async (authenticateData, authenticatedByToken) => {
        let flashVars = await globals.getFlashVarsFromWeb();
        const requestedClientVersion = (globals.rcToken && flashVars.smoke_version)
          ? flashVars.smoke_version : flashVars.deploy_version;

        const playerSessionData = await getPlayerSessionData(
          authenticateData.auth_token,
          requestedClientVersion
        );

        if (playerSessionData.game_server && playerSessionData.game_server != "NONE_AVAIL") {
          if (flashVars.deploy_version != requestedClientVersion) {
            flashVars.deploy_version = requestedClientVersion;
            flashVars.clientURL = `${flashVars.content}${requestedClientVersion}/ajclient.swf?v=${flashVars.build_version}`;
          }
          flashVars.smartfoxServer = playerSessionData.game_server;
          flashVars.blueboxServer = playerSessionData.game_server;
        }

        const userData = {
          username: playerSessionData.screen_name,
          accountType: playerSessionData.game_account_type,
          language: playerSessionData.language,
          authToken: authenticateData.auth_token,
        };
        if (authenticateData.refresh_token) {
          userData.refreshToken = authenticateData.refresh_token;
        }

        globals.authToken = userData.authToken;
        globals.currentUser = userData.username;
        await globals.setLanguage(userData.language);

        // Don't wait for this call, it is purely informational
        reportLogin({
          username: userData.username,
          version: globals.systemData.version,
          platform: globals.systemData.platform,
          userId: playerSessionData.id,
          usedToken: authenticatedByToken,
        });

        appendFlashVars(flashVars);

        return {userData, flashVars};
      };

      const appendFlashVars = (flashVars) => {
        Object.assign(
          flashVars,
          globals.getClientData(),
          globals.reloadFlashVars,
          {
            auth_token: globals.authToken,
            df: globals.df,
            locale: globals.language,
            username: globals.currentUser,
            webRefPath: "game/play",
          },
        );
        globals.reloadFlashVars = null;
      };

      const getPlayerSessionData = async (authToken, clientVersion) => {
        let params = `domain=flash&client_version=${encodeURIComponent(clientVersion)}`;
        if (globals.rcToken) {
          params += "&rc_token=" + encodeURIComponent(globals.rcToken);
        }
        const response = await globals.fetch(`${globals.config.playerSessionData}/player?${params}`, {
          method: "GET",
          mode: "cors",
          headers: {
            "Authorization": `Bearer ${authToken}`,
          },
        }, [401]);
        if (response.status !== 200) {
          throw new Error("AUTH_TOKEN_EXPIRED");
        }
        const responseData = JSON.parse(await response.text());
        if (responseData.rename_required) {
          await showRenameUserModal(responseData.screen_name, responseData.rename_required_key);
          throw new Error("USER_RENAME_NEEDED");
        }
        return responseData;
      };

      const reportLogin = (data) => {
        globals.fetch(`${globals.config.api}/v1/login`, {
          method: "POST",
          mode: "cors",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify(data),
          userAbortController: false,  // prevent user from aborting
        }).catch(err => {
          globals.reportError("webClient", `Failed to contact Electron API: ${err}`);
        });
      };
    </script>

    <!-- load modules -->

    <script src="components/Button.js"></script>
    <script src="components/LoginScreen.js"></script>
    <script src="components/GameScreen.js"></script>
    <script src="components/TextInput.js"></script>
    <script src="components/ErrorTip.js"></script>
    <script src="components/BubbleButton.js"></script>
    <script src="components/GameButtonTray.js"></script>
    <script src="components/ButtonWithText.js"></script>
    <script src="components/Checkbox.js"></script>
    <script src="components/RenameUserModal.js"></script>
    <script src="components/SpriteSheetButton.js"></script>
    <script src="components/MessageModal.js"></script>
    <script src="components/ForgotPasswordModal.js"></script>
    <script src="components/OtpModal.js"></script>
    <script src="components/ProgressRing.js"></script>

    <div id="modal-layer"></div>
    <ajd-login-screen id="login-screen"></ajd-login-screen>
    <ajd-game-screen id="game-screen"></ajd-game-screen>

    <script>
      "use strict";

      (() => {
        const loginScreen = document.getElementById("login-screen");
        const gameScreen = document.getElementById("game-screen");

        loginScreen.addEventListener("loggedIn", event => {
          gameScreen.loadGame(event.detail.flashVars);
          //gameScreen.loadGame({"content":"https://ajcontent.akamaized.net/","blueboxPort":"443","smartfoxPort":"443","website":"http://www.animaljam.com/","build_version":"1","mdUrl":"https://jammercentral.animaljam.com/game/","deploy_version":"1711","sbStatTrackerIp":"stats.animaljam.com","sbStatModulator":"16","smoke_version":"1711","playerWallHost":"https://prod-wall.animaljam.com/wall","smartfoxServer":"iss02-classic.prod.animaljam.internal","blueboxServer":"iss02-classic.prod.animaljam.internal","clientURL":"https://ajcontent.akamaized.net/1711/ajclient.swf?v=1","currentTimestamp":1741252325,"country":"GB","locale":"en"});
        });
        gameScreen.addEventListener("gameLoaded", event => {
          loginScreen.loginBlocked = false;
          gameScreen.classList.add("show");
          // Give time for the transition animation to play
          setTimeout(() => {
            document.getElementById("login-screen").localize();
          }, 1000);
        });
        gameScreen.addEventListener("loadFailed", event => {
          loginScreen.loginBlocked = false;
        });
        gameScreen.addEventListener("switchToLogin", event => {
          gameScreen.classList.remove("show");
        });
        gameScreen.addEventListener("accountCreated", event => {
          if (loginScreen.authToken) {
            loginScreen.clearAuthToken();
          }
          if (loginScreen.refreshToken) {
            loginScreen.clearRefreshToken();
          }
          loginScreen.username = event.detail.username;
          loginScreen.password = event.detail.password;
          loginScreen.rememberMe = true;
        });
        gameScreen.addEventListener("newAccountLoggedIn", event => {
          loginScreen.authToken = event.detail.authToken;
          loginScreen.refreshToken = event.detail.refreshToken;
        });

        window.onload = () => {
          document.querySelector("body").classList.add("show");

          // prevent user from dragging image onto app and redirecting
          document.addEventListener("dragover", event => {
            event.preventDefault();
            return false;
          }, false);
          document.addEventListener("drop", event => {
            event.preventDefault();
            return false;
          }, false);
        };

        document.addEventListener("loginInfoLoaded", (event) => {
          const data = event.detail;
          loginScreen.username = data.username;
          loginScreen.rememberMe = data.rememberMe;
          loginScreen.authToken = data.authToken || null;
          loginScreen.refreshToken = data.refreshToken || null;
          globals.config = data.config;
          globals.currentUser = data.username;
          globals.df = data.df;
          globals.rcToken = data.rcToken;
          if (data.rememberMe && data.username && (data.authToken || data.refreshToken)) {
            loginScreen.isFakePassword = true;
            loginScreen.logIn();
          }
          else {
            loginScreen.isFakePassword = false;
            loginScreen.password = "";
          }
        });

        window.addEventListener("keydown", event => {
          document.dispatchEvent(new CustomEvent("keyEvent", {
            metaKey: event.metaKey,
            altKey: event.altKey,
            ctrlKey: event.ctrlKey,
            shiftKey: event.shiftKey,
            keyCode: event.keyCode,
            key: event.key,
          }));
        }, true);

        document.dispatchEvent(new CustomEvent("loaded"));

        document.addEventListener("postSystemData", (event) => {
          const data = globals.systemData;
          globals.systemData.version = data.version || globals.systemData.version;
          globals.systemData.platform = data.platform || globals.systemData.platform;
          globals.systemData.platformRelease = data.platformRelease || globals.systemData.platformRelease;
          loginScreen.version = globals.systemData.version;
          globals.affiliateCode = data.affiliateCode;
          globals.setLanguage(data.language);
          globals.localize();
        });
        document.dispatchEvent(new CustomEvent("postSystemData"));


        document.addEventListener("obtainedToken", (event) => {
          try {
            loginScreen.authToken = event.detail.token;
            loginScreen.logIn();
          }
          catch (err) {
            globals.reportError("webClient", err);
          }
        });

        document.dispatchEvent(new CustomEvent("ready"));

        document.addEventListener("log", (event) => {
          if (event.detail.level.toLowerCase() === "error") {
            globals.reportError("electronClient", event.detail.message);
          }
          switch (event.detail.level) {
            case "debug": console.debug(event.detail.message); break;
            case "warn": console.warn(event.detail.message); break;
            case "error": console.error(event.detail.message); break;
            default: console.log(event.detail.message); break;
          }
        });
      })();
    </script>
</body>
</html>
